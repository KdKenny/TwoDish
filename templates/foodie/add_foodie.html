{% extends 'base.html' %}
{% load static %}

{% block title %}å®Œå–„å€‹äººè³‡æ–™ - å…©é¤¸é£¯æœæŸ¥çµ„{% endblock %}

{% block content %}
<style>
/* ä¿®æ­£ alert æ¨£å¼ï¼Œé¿å…å½±éŸ¿æ»¾å‹• */
.alert {
    position: relative !important;
    z-index: 1 !important;
    margin-bottom: 20px;
    max-width: 100%;
    overflow: visible;
}

/* ä¿®æ­£è¡¨å–®å®¹å™¨ */
.card-login {
    margin-bottom: 50px;
    margin-top: 50px;
}

/* æ·»åŠ èƒŒæ™¯æ¨£å¼ */
.form-section {
    background: linear-gradient(135deg,rgb(250, 131, 72) 0%,rgb(255, 255, 255) 100%);
    min-height: 100vh;
    padding: 50px 0;
}
</style>

<div class="form-section">
  <div class="container">
    <div class="col-md-6 ml-auto mr-auto">
      <div class="card card-login card-plain">
        <form class="form" method="post" 
              action="{% if is_edit %}{% url 'foodie:edit_foodie' %}{% else %}{% url 'foodie:add_foodie' %}{% endif %}" 
              enctype="multipart/form-data">
          {% csrf_token %}
          <div class="card-header text-center">
            <div class="logo-container">
              <img src="{% static 'img/now-logo.png' %}" alt="">
            </div>
          </div>
          <div class="card-body">
            <h2 class="text-center text-danger">å®Œå–„å€‹äººè³‡æ–™</h2>
            <p class="text-center text-danger">è®“å…¶ä»–æœƒå“¡æ›´äº†è§£ä½ ï¼</p>
            
            <!-- é¡¯ç¤ºè¨Šæ¯ -->
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible" role="alert" style="position: relative; z-index: 1; margin-bottom: 20px;">
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}

            <!-- æ·»åŠ  JavaScript ä¾†æ”¹å–„æ»¾å‹•é«”é©— -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              // å¦‚æœæœ‰ alert è¨Šæ¯ï¼Œç¢ºä¿é é¢å¯ä»¥æ»¾å‹•
              const alerts = document.querySelectorAll('.alert');
              if (alerts.length > 0) {
                // ç§»é™¤å¯èƒ½å½±éŸ¿æ»¾å‹•çš„æ¨£å¼
                document.body.style.overflow = 'auto';
                document.documentElement.style.overflow = 'auto';
                
                // å»¶é²å¾Œè‡ªå‹•æ»¾å‹•åˆ°è¡¨å–®å€åŸŸ
                setTimeout(function() {
                  const cardBody = document.querySelector('.card-body');
                  if (cardBody) {
                    cardBody.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  }
                }, 500);
              }
            });
            </script>

              <!-- å€‹äººé ­åƒ -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons users_single-02"></i></span>
                </div>
                <input type="file" name="profile_photo" class="form-control" accept="image/*">
              </div>
              <small class="form-text text-dark">ä¸Šå‚³å€‹äººé ­åƒ (å¯é¸)</small>

              <!-- æš±ç¨± -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons users_circle-08"></i></span>
                </div>
                <h2 class="card-title" style="color: #333;">
                  {% if is_edit %}ä¿®æ”¹å€‹äººè³‡æ–™{% else %}å»ºç«‹å€‹äººè³‡æ–™{% endif %}
                </h2>
                
                <!-- åœ¨å„å€‹è¼¸å…¥æ¬„ä½ä¸­æ·»åŠ  value å±¬æ€§ -->
                <input type="text" id="nickname" name="nickname" 
                       value="{% if is_edit %}{{ foodie.foodie_name }}{% endif %}" 
                       placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±..." required>
              </div>

              <!-- å¹´é½¡ç¯„åœ - ä½¿ç”¨æ­£ç¢ºçš„é¸é … -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons ui-1_calendar-60"></i></span>
                </div>
                <select name="age_range" class="form-control" style="font-size: 16px; padding: 12px;" required>
                  <option value="">é¸æ“‡å¹´é½¡ç¯„åœ...</option>
                  <option value="18-25">18-25æ­²</option>
                  <option value="26-35">26-35æ­²</option>
                  <option value="36-45">36-45æ­²</option>
                  <option value="46-55">46-55æ­²</option>
                  <option value="56+">56æ­²æˆ–ä»¥ä¸Š</option>
                </select>
              </div>

              <!-- å±…ä½åœ°å€ - ä½¿ç”¨è©³ç´°åœ°å€é¸é … -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons location_pin"></i></span>
                </div>
                <select name="location" class="form-control" style="font-size: 16px; padding: 12px;" required>
                  <option value="">é¸æ“‡å±…ä½åœ°å€...</option>
                  <option value="Central & Western">ä¸­è¥¿å€</option>
                  <option value="Eastern">æ±å€</option>
                  <option value="Southern">å—å€</option>
                  <option value="Wan Chai">ç£ä»”</option>
                  <option value="Kowloon City">ä¹é¾åŸ</option>
                  <option value="Kwun Tong">è§€å¡˜</option>
                  <option value="Sham Shui Po">æ·±æ°´åŸ—</option>
                  <option value="Wong Tai Sin">é»ƒå¤§ä»™</option>
                  <option value="Yau Tsim Mong">æ²¹å°–æ—º</option>
                  <option value="Islands">é›¢å³¶</option>
                  <option value="Kwai Tsing">è‘µé’</option>
                  <option value="North">åŒ—å€</option>
                  <option value="Sai Kung">è¥¿è²¢</option>
                  <option value="Sha Tin">æ²™ç”°</option>
                  <option value="Tai Po">å¤§åŸ”</option>
                  <option value="Tsuen Wan">èƒç£</option>
                  <option value="Tuen Mun">å±¯é–€</option>
                  <option value="Yuen Long">å…ƒæœ—</option>
                </select>
              </div>

              <!-- æ€§åˆ¥ -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons users_single-02"></i></span>
                </div>
                <select name="gender" class="form-control" style="font-size: 16px; padding: 12px;" required>
                  <option value="">é¸æ“‡æ€§åˆ¥...</option>
                  <option value="Male">ç”·</option>
                  <option value="Female">å¥³</option>
                  <option value="Other">å…¶ä»–</option>
                </select>
              </div>

              <!-- è·æ¥­ -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons business_briefcase-24"></i></span>
                </div>
                <select name="occupation" class="form-control" style="font-size: 16px; padding: 12px;" required>
                  <option value="">é¸æ“‡è·æ¥­...</option>
                  <option value="office">ç™½é ˜</option>
                  <option value="technical">æŠ€å·¥</option>
                  <option value="driver">å¸æ©Ÿ</option>
                  <option value="wife">ä¸»å©¦</option>
                  <option value="boss">è€é—†</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>

              <!-- é£²é£Ÿåå¥½ - æ”¹ç”¨æŒ‰éˆ•çµ„æ–¹å¼ -->
              <div class="form-group">
                <label class="text-dark" style="font-size: 18px; font-weight: bold; color: #333 !important; margin-bottom: 15px;">é£²é£Ÿåå¥½ (å¯å¤šé¸):</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="btn-group-vertical d-block" role="group">
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="ä¸­å¼" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸ¥¢ ä¸­å¼</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="è¥¿å¼" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸ½ï¸ è¥¿å¼</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="æ—¥å¼" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸ£ æ—¥å¼</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="éŸ“å¼" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸ¥˜ éŸ“å¼</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="æ³°å¼" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸŒ¶ï¸ æ³°å¼</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="ç´ é£Ÿ" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸ¥— ç´ é£Ÿ</button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="btn-group-vertical d-block" role="group">
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="æœ‰æ©Ÿ" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸŒ± æœ‰æ©Ÿé£Ÿå“</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="æµ·é®®" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸ¦ æµ·é®®</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="æ¸…çœŸ" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">â˜ªï¸ æ¸…çœŸé£Ÿå“</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="ä¸åƒç‰›è‚‰" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸš«ğŸ„ ä¸åƒç‰›è‚‰</button>
                      <button type="button" class="btn btn-outline-primary food-pref-btn mb-2" data-value="ä¸åƒè±¬è‚‰" style="text-align: left; padding: 12px 15px; font-size: 16px; border-radius: 8px; color: #333;">ğŸš«ğŸ· ä¸åƒè±¬è‚‰</button>
                    </div>
                  </div>
                </div>
                <!-- éš±è—çš„è¼¸å…¥æ¬„ä½ä¾†å­˜å„²é¸ä¸­çš„å€¼ -->
                <input type="hidden" name="food_preferences" id="food_preferences_input" value="">
              </div>

              <!-- æ·»åŠ  JavaScript ä¾†è™•ç†æŒ‰éˆ•é»æ“Š -->
              <script>
              document.addEventListener('DOMContentLoaded', function() {
                const foodPrefButtons = document.querySelectorAll('.food-pref-btn');
                const hiddenInput = document.getElementById('food_preferences_input');
                let selectedPrefs = [];

                // åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œé è¨­é¸ä¸­çš„é£²é£Ÿåå¥½
                {% if is_edit %}
                  {% if foodie.favor_chinese %}selectedPrefs.push('ä¸­å¼');{% endif %}
                  {% if foodie.favor_western %}selectedPrefs.push('è¥¿å¼');{% endif %}
                  {% if foodie.favor_japan %}selectedPrefs.push('æ—¥å¼');{% endif %}
                  {% if foodie.favor_korean %}selectedPrefs.push('éŸ“å¼');{% endif %}
                  {% if foodie.favor_thai %}selectedPrefs.push('æ³°å¼');{% endif %}
                  {% if foodie.favor_veg %}selectedPrefs.push('ç´ é£Ÿ');{% endif %}
                  {% if foodie.favor_organic %}selectedPrefs.push('æœ‰æ©Ÿ');{% endif %}
                  {% if foodie.favor_seafood %}selectedPrefs.push('æµ·é®®');{% endif %}
                  {% if foodie.favor_muslim %}selectedPrefs.push('æ¸…çœŸ');{% endif %}
                  {% if foodie.favor_no_beef %}selectedPrefs.push('ä¸åƒç‰›è‚‰');{% endif %}
                  {% if foodie.favor_no_pork %}selectedPrefs.push('ä¸åƒè±¬è‚‰');{% endif %}
                  
                  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                  foodPrefButtons.forEach(button => {
                    const value = button.getAttribute('data-value');
                    if (selectedPrefs.includes(value)) {
                      button.classList.remove('btn-outline-primary');
                      button.classList.add('btn-primary');
                    }
                  });
                  
                  // æ›´æ–°éš±è—è¼¸å…¥æ¬„ä½
                  hiddenInput.value = selectedPrefs.join(',');
                {% endif %}

                foodPrefButtons.forEach(button => {
                  button.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    
                    if (this.classList.contains('btn-primary')) {
                      // å–æ¶ˆé¸æ“‡
                      this.classList.remove('btn-primary');
                      this.classList.add('btn-outline-primary');
                      selectedPrefs = selectedPrefs.filter(pref => pref !== value);
                    } else {
                      // é¸æ“‡
                      this.classList.remove('btn-outline-primary');
                      this.classList.add('btn-primary');
                      selectedPrefs.push(value);
                    }
                    
                    // æ›´æ–°éš±è—è¼¸å…¥æ¬„ä½
                    hiddenInput.value = selectedPrefs.join(',');
                  });
                });
              });
              </script>

              <!-- å€‹äººç°¡ä»‹ -->
              <div class="input-group no-border input-lg">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="now-ui-icons text_caps-small"></i></span>
                </div>
                <textarea name="foodie_desc" class="form-control" placeholder="è«‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹è‡ªå·±..." rows="4" style="font-size: 16px; padding: 12px;">{% if is_edit %}{{ foodie.foodie_desc }}{% endif %}</textarea>
              </div>

            </div>
            <div class="card-footer text-center">
              <button type="submit" class="btn btn-primary btn-round btn-lg btn-block">å®Œæˆè¨»å†Š</button>
              <div class="pull-left">
              </div>
              <div class="pull-right">
                <h6>
                  <a href="#" class="link">éœ€è¦å¹«åŠ©?</a>
                </h6>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}